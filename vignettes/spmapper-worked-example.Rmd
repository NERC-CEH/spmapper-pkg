---
title: "Worked example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Worked example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
date: "2025-05-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Load packages and functions

```{r echo=FALSE}
library(spmapper)
library(terra) ## note: needed in 'fpudoverlap'
library(sf)
library(knitr)
library(rnaturalearth)
#library(rnaturalearthhires)
library(viridis)
library(ggplot2)
library(patchwork)

tooldir <- system.file("extdata", package = "spmapper")

system.file("R", "functions_preymodel.R", package = "spmapper")
system.file("R", "functions_spmapper.R", package = "spmapper")
system.file("R", "functions_fpudoverlap.R", package = "spmapper")
system.file("R", "functions_spmapplot.R", package = "spmapper")

```

# Worked example - NnG and Berwick Bank

## User specified polygon(s) to use in example

NOTE: TEMPORARY

```{r echo=FALSE}
# Example polygons
# UK offshore windfarms (Sourced via EMODNet)
fppolys <- sf::st_read(system.file("demo/UK_OWF_polygons_by_status", package = "spmapper"))
fppolys <- fppolys %>% dplyr::filter(country == "United Kingdom")
fppolys <- fppolys %>% dplyr::filter(status %in% c("Approved", "Construction", "Planned", "Production" )) 
fppolys <- fppolys %>% dplyr::filter(!grepl("OFTO", name)) # exclude cable polygons
proj.laea <- '+proj=laea +lat_0=-7.947 +lon_0=-14.30 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84  +units=m +no_defs'
fppolys <-  st_transform(fppolys, crs = proj.laea)

fppolys <-  fppolys %>% dplyr::filter(name == "SeaGreen Alpha") # filter for one OWF for now <<<<<<<<<<<<<<<<<<<<<<<<<<<<<< REMOVE/REPLACE

# Union of polygons to avoid double counting within overlapping polygons
fppolys <- st_union(fppolys) # combine overlapping elements 
fppolys <- st_sf(geometry = st_cast(fppolys, "POLYGON"))  # return to sfc


# Example BLKI UD for testing code
file_udmap <- system.file("extdata", paste0("FAME_UD_standardised_", "BLKI", ".tif"), package = "spmapper")
udmap <- terra::rast(file_udmap)
terra::crs(udmap) <- '+proj=laea +lat_0=-7.947 +lon_0=-14.30 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0'
  
spmapplot(udmap,fppolys) # this colour scale wont work for raster as this is UD values, much less than prey map values, just used to test 

```

## Run tool for each species

```{r}
out_kitt <- spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)

out_cogu <- spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)

out_razo <- spmapper(spname = "Razorbill", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

## Show UD map

```{r multi-species-map, fig.alt = "Composite map showing prey consumption for Kittiwake, Guillemot, and Razorbill", fig.width=8, fig.height=6}
par(mfrow=c(2,2))
par(mfrow=c(2,2))
par(mar=c(2,2,2,2))  # bottom, left, top, right
(spmapplot(out_kitt$prey_cons_map, fppolys) + ggtitle("Kittiwake")) +
(spmapplot(out_cogu$prey_cons_map, fppolys) + ggtitle("Guillemot")) +
(spmapplot(out_razo$prey_cons_map, fppolys) + ggtitle("Razorbill")) + 
  patchwork::plot_layout(ncol = 2)

# SPACING ISSUE
```

## Visualize outputs


```{r, out.width="50%"}
par(mfrow=c(2,2))
par(mar=c(2,2,2,2))  # bottom, left, top, right

hist(out_kitt$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Kittiwake")
lines(rep(out_kitt$allbirds_prey_est,2),c(0,10000),lwd=2)

hist(out_cogu$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Guillemot")
lines(rep(out_cogu$allbirds_prey_est,2),c(0,10000),lwd=2)

hist(out_razo$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Razorbill")
lines(rep(out_razo$allbirds_prey_est,2),c(0,10000),lwd=2)
```

## Tables

```{r}
dev.off()
tab_kitt <- data.frame(
  Species = "Kittiwake",
  Estimate = out_kitt$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_kitt$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_kitt$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_kitt$allbirds_prey_sim, 0.975)))

tab_cogu <- data.frame(
  Species = "Guillemot",
  Estimate = out_cogu$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_cogu$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_cogu$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_cogu$allbirds_prey_sim, 0.975)))

tab_razo <- data.frame(
  Species = "Razorbill",
  Estimate = out_razo$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_razo$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_razo$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_razo$allbirds_prey_sim, 0.975)))

kable(rbind(tab_kitt, tab_cogu, tab_razo))
```

# Testing mis-specification of inputs

## Incorrect species name

The tool explicitly checks whether the provided species names are valid (including capitalisation)

```{r error=TRUE}
spmapper(spname = "kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

## Incorrect population scenario

The tool explicitly checks whether the provided scenario names are valid (including capitalisation)

```{r error=TRUE}
spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "medium", tooldir = tooldir)
```

## Incorrect path to tool

The tool does not currently explicitly check if the path provided is correct/valid, but seems to yield a fairly sensible error messages if an incorrect path is specified

```{r error=TRUE}
spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = "test")
```
## Validity of footprints

The tool does not check directly for the validity of the polygons provided

## Inconsistencies between footprint polygons and UDs

The tool runs three checks for consistency between polygons and the UD map

### Footprints smaller than one grid cell

```{r error=TRUE}
fppolys <- sf::st_read(system.file("demo/North_Sea_OWF_2030_polygons", package = "spmapper"))
fppolys <- fppolys[which.min(sf::st_area(fppolys)),]

spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```
### Footprints outside extent of UD

Note: the extent of the UD maps varies between species

```{r error=TRUE}
fppolys <- sf::st_read(system.file("demo/North_Sea_OWF_2030_polygons", package = "spmapper"))

fppolys <- fppolys[1,]

spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

### Footprints on land (or in other areas of map without values)

Note: this may be footprints on land, but it could also be footprints in areas that are within extent but have missing values as weren't included in the original modelling in Wakefield et al. (2017)

```{r error=TRUE}
fppolys <- sf::st_read(system.file("demo/North_Sea_OWF_2030_polygons", package = "spmapper"))

fppolys <- fppolys[155,]

spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

