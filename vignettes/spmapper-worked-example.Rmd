---
title: "Worked example for 'spmapper'"
output: html_document
date: "2025-05-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages and functions

```{r echo=FALSE}
library(terra) ## note: needed in 'fpudoverlap'
library(sf)
library(knitr)

tooldir <- file.path("/data", "notebooks", "rstudio-spmapper")

source(file.path(tooldir, "R", "functions_preymodel.R"))
source(file.path(tooldir, "R", "functions_spmapper.R"))
source(file.path(tooldir, "R", "functions_fpudoverlap.R"))
```

# Worked example - NnG and Berwick Bank

## User specified polygon(s) to use in example

NOTE: TEMPORARY

```{r echo=FALSE}
fppolys <- sf::st_read(file.path(tooldir, "ExampleData", "North_Sea_OWF_2030_polygons"))

fppolys <- fppolys[c(112,116),] ## NnG and Berwick Bank
```

## Run tool for each species

```{r}
out_kitt <- spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)

out_cogu <- spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)

out_razo <- spmapper(spname = "Razorbill", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

## Show UD map

```{r}
par(mfrow=c(2,2))
plot(out_kitt$udmap, main="Kittiwake")
plot(out_cogu$udmap, main="Guillemot")
plot(out_razo$udmap, main="Razorbill")
```

## Visualize outputs

```{r}
par(mfrow=c(2,2))

hist(out_kitt$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Kittiwake")
lines(rep(out_kitt$allbirds_prey_est,2),c(0,10000),lwd=2)

hist(out_cogu$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Guillemot")
lines(rep(out_cogu$allbirds_prey_est,2),c(0,10000),lwd=2)

hist(out_razo$allbirds_prey_sim, breaks=50, col=gray(0.6), main="Razorbill")
lines(rep(out_razo$allbirds_prey_est,2),c(0,10000),lwd=2)
```

## Tables

```{r}
tab_kitt <- data.frame(
  Species = "Kittiwake",
  Estimate = out_kitt$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_kitt$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_kitt$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_kitt$allbirds_prey_sim, 0.975)))

tab_cogu <- data.frame(
  Species = "Guillemot",
  Estimate = out_cogu$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_cogu$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_cogu$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_cogu$allbirds_prey_sim, 0.975)))

tab_razo <- data.frame(
  Species = "Razorbill",
  Estimate = out_razo$allbirds_prey_est, 
  Sim_CI_Lower = as.numeric(quantile(out_razo$allbirds_prey_sim, 0.025)), 
  Sim_Mean = mean(out_razo$allbirds_prey_sim), 
  Sim_CI_Upper = as.numeric(quantile(out_razo$allbirds_prey_sim, 0.975)))

kable(rbind(tab_kitt, tab_cogu, tab_razo))
```

# Testing mis-specification of inputs

## Incorrect species name

The tool explicitly checks whether the provided species names are valid (including capitalisation)

```{r error=TRUE}
spmapper(spname = "kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

## Incorrect population scenario

The tool explicitly checks whether the provided scenario names are valid (including capitalisation)

```{r error=TRUE}
spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "medium", tooldir = tooldir)
```

## Incorrect path to tool

The tool does not currently explicitly check if the path provided is correct/valid, but seems to yield a fairly sensible error messages if an incorrect path is specified

```{r error=TRUE}
spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = "test")
```
## Validity of footprints

The tool does not check directly for the validity of the polygons provided

## Inconsistencies between footprint polygons and UDs

The tool runs three checks for consistency between polygons and the UD map

### Footprints smaller than one grid cell

```{r error=TRUE}
fppolys <- sf::st_read(file.path(tooldir, "ExampleData", "North_Sea_OWF_2030_polygons"))

fppolys <- fppolys[which.min(sf::st_area(fppolys)),]

spmapper(spname = "Kittiwake", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```
### Footprints outside extent of UD

Note: the extent of the UD maps varies between species

```{r error=TRUE}
fppolys <- sf::st_read(file.path(tooldir, "ExampleData", "North_Sea_OWF_2030_polygons"))

fppolys <- fppolys[1,]

spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

### Footprints on land (or in other areas of map without values)

Note: this may be footprints on land, but it could also be footprints in areas that are within extent but have missing values as weren't included in the original modelling in Wakefield et al. (2017)

```{r error=TRUE}
fppolys <- sf::st_read(file.path(tooldir, "ExampleData", "North_Sea_OWF_2030_polygons"))

fppolys <- fppolys[155,]

spmapper(spname = "Guillemot", fppolys = fppolys, popscen = "baseline", tooldir = tooldir)
```

